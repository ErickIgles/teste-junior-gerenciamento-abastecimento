{% extends 'home_template/pages/base.html' %}

{% load static %}

{% block title %} Rebastecimento {% endblock %}
    
{% block head %}
    <link rel="stylesheet" href="{% static 'abastecimento/css/lista_abastecimento.css' %}">
{% endblock  %}

{% block main %}

    <div class="campo-pagina">


        <div tyle="display: flex; flex-direction: column; margin: 10px; gap: 20px;">

            <div>
                <h2 style="margin-top: 15px">Reabastecimento</h2>
            </div>


            <div class="cards-resumo">

                <div class="card">
                    <h4>Volume Reabastecido</h4>
                    {{ total_litros }}
                </div>
                <div class="card">
                    <h4>Valor total do reabastecimento</h4>
                    {{ total_valor }}
                </div>
                <div class="card">
                    <h4>Combustivel mais reabastecido</h4>
                    {{ combustivel_mais_reabastecido.tanque__tipo_combustivel__nome_combustivel }}
                </div>

            </div>
        </div>

        
        {% include 'home_template/partials/messages.html' %}

        <nav class="nav-pesquisa">
            <form method="GET" class="form">

                <div>
                    <input type="text" class="form-input" placeholder="Pesquisar..." name="q">
                </div>
                <button type="submit" class="button-pesquisa">
                    üîç
                </button>
                <div class="espaco-datas">
                    <input type="date" name="data_inicio" class="form-data">
                    <input type="date" name="data_fim" class="form-data">
                </div>
            </form>

            <div class="acoes-buttons">

                <button
                    
                    type="button"
                    class="novo-registro" 
                    href="{% url 'servicos:abastecimento:cadastrar_reabastecimento' %}"
            
                >
                    Novo registro
                </button>

            </div>


        </nav>


        {% if page_obj %}
            <div class="lista">
                <table class="tabela">
                    <thead class="tabela-cabecalho">
                        <tr>
                            <th>Respons√°vel</th>
                            <th>Tanque</th>
                            <th>Fornecedor</th>
                            <th>Volume abastecido</th>
                            <th>Data</th>
                            <th>Valor R$</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    
                    {% for reabastecimento, form  in forms_edicao %}
                        <tbody class="tabela-body">
                            <tr>
                                <td>
                                    {% if reabastecimento.funcionario %}
                                        
                                        {{ reabastecimento.funcionario }}
                                    
                                    {% else %}

                                        {{ reabastecimento.empresa }}
                                    
                                    {% endif %}
                                </td>

                                <td>
                                    {% if reabastecimento.tanque %}
                                        {{ reabastecimento.tanque.identificador_tanque }}
                                    {% else %}
                                        N√£o h√° tanque registrado
                                    {% endif %}
                                </td>

                                <td>
                                    {{ reabastecimento.fornecedor.nome_fantasia }}
                                </td>
                                <td>
                                    {{ reabastecimento.quantidade }}
                                </td>
                                <td>
                                    {{ reabastecimento.criado }}
                                </td>
                                <td>
                                    {{ reabastecimento.valor_total_reabastecimento }}
                                </td>

                                <td class="acoes-buttons">
                                    <form action="{% url 'servicos:abastecimento:deletar_reabastecimento' reabastecimento.pk %}?next={{ request.get_full_path }}">
                                        {% csrf_token %}
                                        <button
                                            type="submit"
                                            class="btn deletar"
                                        >
                                            <i class="fas fa-trash"></i>                                             
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    {% endfor %}
                </table>
            </div>

            <div class="paginacao">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">¬´</a>
                {% endif %}

                <span>
                    P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">¬ª</a>
                {% endif %}
            </div>

        {% else %}
            <h2>N√£o h√° registros de Rebastecimentos</h2>
        {% endif %}

    </div>

    <div id="modalCadastro" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Novo Reabastecimento</h2>
            <form method="POST" action="{% url 'servicos:abastecimento:cadastrar_reabastecimento' %}">
                {% csrf_token %}
                <div class="modal-form-grid">

                    
                    {% for field in form %}
                        
                        <div class="form-group">

                            {{ field.label_tag }}
                            {{ field }}

                            {% if field.errors %}

                                {% for error in field.errors %}

                                    <p class="messages-error">{{ error }}</p>

                                {% endfor %}

                            {% endif %}
                        </div>
                    {% endfor %}

                </div>

                <button type="submit">Cadastrar</button>
            </form>
        </div>
    </div>

    {% block script %}

        <script>
            // --- Modal de cadastro ---
            const modalCadastro = document.getElementById("modalCadastro");
            const btnCadastro = document.querySelector(".novo-registro");
            const spanCadastro = document.querySelector("#modalCadastro .close");

            btnCadastro.addEventListener("click", function(event) {
                event.preventDefault();
                modalCadastro.style.display = "block";
            });

            spanCadastro.addEventListener("click", function() {
                modalCadastro.style.display = "none";
            });

            window.addEventListener("click", function(event) {
                if (event.target === modalCadastro) {
                    modalCadastro.style.display = "none";
                }
            });

            // --- Fun√ß√µes gen√©ricas para modais de edi√ß√£o ---
            function abrirModal(id) {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.style.display = "block";
                }
            }

            function fecharModal(id) {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.style.display = "none";
                }
            }

            // --- Fecha qualquer modal ao clicar no X ---
            document.querySelectorAll(".modal .close").forEach(function(span) {
                span.addEventListener("click", function() {
                    const modal = span.closest(".modal");
                    if (modal) {
                        modal.style.display = "none";
                    }
                });
            });

            // --- Fecha modal ao clicar fora ---
            window.addEventListener("click", function(event) {
                if (event.target.classList.contains("modal")) {
                    event.target.style.display = "none";
                }
            });
        </script>
    {% endblock %}
{% endblock %}