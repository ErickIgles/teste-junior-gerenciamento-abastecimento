{% extends 'home_template/pages/base.html' %}

{% load static %}

{% block title %} Abastecimento {% endblock %}
    
{% block head %}
    <link rel="stylesheet" href="{% static 'abastecimento/css/lista_abastecimento.css' %}">
{% endblock  %}

{% block main %}
    <div class="campo-pagina">

        <div style="display: flex; flex-direction: column; margin: 10px; gap: 20px;">
            <div>
                <h2 style="margin-top: 10px;">Abastecimento</h2>
            </div>


            <!--CARS PARA QUANTIDADE CONSUMIDA/ VALOR TOTAL/ TIPO TANQUE COM MAIS SAIDA-->

            <div class="cards-resumo">

                <div class="card">
                    <h4>Volume consumido</h4>
                    {{ total_litros }}
                </div>
                <div class="card">
                    <h4>Valor total de abastecimento</h4>
                    {{ total_valor }}
                </div>
                <div class="card">
                    <h4>Combustivel mais pedido</h4>
                    {{ combustivel_mais_pedido.tipo_combustivel__nome_combustivel }}
                </div>

            </div>
        </div>

            
        <nav class="nav-pesquisa">
            <form method="GET" class="form">
                
                <input type="text" class="form-input" placeholder="Pesquisar..." name="q">

                <button type="submit" class="button-pesquisa">
                    üîç
                </button>
                <div class="espaco-datas">
                    <input type="date" name="data_inicio" class="form-data">
                    <input type="date" name="data_fim" class="form-data">
                </div>
            </form>

            <div class="acoes-buttons">
                <button
                    type="button"
                    class="novo-registro"             
                >
                    Novo registro
                </button>
            </div>


        </nav>


        {% if page_obj %}
            <div class="lista">
                <table class="tabela">
                    
                    <thead class="tabela-cabecalho">
                        <tr>
                            <th>Respons√°vel</th>
                            <th>Tanque</th>
                            <th>Bomba</th>
                            <th>Tipo</th>
                            <th>Consumida L</th>
                            <th>Data</th>
                            <th>Valor total R$</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                        
                        
                    {% for abastecimento, form in forms_edicao %}
                        <tbody class="tabela-body">
                            <tr>
                                <td data-label="Responsvel">
                                    {% if abastecimento.funcionario %}
                                        {{ abastecimento.funcionario.username }}
                                    {% else %}
                                        {{ abastecimento.empresa }}
                                    {% endif %}
                                </td>

                                <td data-label="Tanque">
                                    {% if abastecimento.tanque %}
                                            {{ abastecimento.tanque.identificador_tanque }}
                                    {% else %}
                                        N√£o h√° cargo registrado
                                    {% endif %}
                                </td>
                                <td data-label="Bomba">
                                    {% if abastecimento.bomba %}
                                        {{ abastecimento.bomba.nome_bomba }}
                                    {% else %}
                                        N√£o h√° bomba registrada
                                    {% endif %}
                                </td>
                                <td data-label="Tipo">
                                    {% if abastecimento.tanque %}
                                        {{ abastecimento.tanque.tipo_combustivel }}
                                    {% else %}
                                        N√£o h√° tipo de combust√≠vel registrado
                                    {% endif %}
                                </td>
                                <td data-label="Consumida">
                                    {{ abastecimento.litros_abastecido }}
                                </td>
                                <td data-label="Data">
                                   {{ abastecimento.criado }}
                                </td>

                                <td data-label="Valor total R$">
                                    {{ abastecimento.valor_total_abastecimento }}
                                </td>


                                <td data-label="A√ß√µes" class="acoes-buttons">
                                    <button 
                                        type="button"
                                        class="btn atualizar" 
                                        onclick="abrirModal('modalEditar{{ abastecimento.id }}')">
                                        <i class="fas fa-edit">
                                        </i>
                                    </button>

                                    <form method="POST" action="{% url 'servicos:abastecimento:deletar' abastecimento.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn deletar">
                                            <i class="fas fa-trash"></i>                                             
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>

                        <div id="modalEditar{{ abastecimento.id }}" class="modal">
                            <div class="modal-content">
                                <span class="close" onclick="fecharModal('modalEditar{{ abastecimento.id }}')">&times;</span>
                                <h2>Editar Abastecimento</h2>
                                <form method="POST" action="{% url 'servicos:abastecimento:atualizar' abastecimento.id %}">
                                        {% csrf_token %}
                                    <div class="modal-form-grid">
                                        {% for field in form %}
                                             <div class="form-group">
                                                {{ field.label_tag }}
                                                {{ field }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="submit">Salvar Altera√ß√µes</button>
                                </form>
                            </div>
                        </div>
                    {% endfor %}
                </table>
            </div>


            {% if page_obj %}

                <div class="paginacao">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">¬´</a>
                    {% endif %}

                    <span>
                        P√°gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&data_inicio={{ request.GET.data_inicio }}&data_fim={{ request.GET.data_fim }}">¬ª</a>
                    {% endif %}
                </div>

            {% endif %}

        {% else %}
            <h2>N√£o h√° registros de Abastecimentos</h2>
        {% endif %}


    </div>
    

    <div id="modalCadastro" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Novo Abastecimento</h2>
            <form method="POST" action="{% url 'servicos:abastecimento:cadastrar' %}">
                {% csrf_token %}
                <div class="modal-form-grid">

                    
                    {% for field in form %}
                        
                        <div class="form-group">

                            {{ field.label_tag }}
                            {{ field }}

                            {% if field.errors %}

                                {% for error in field.errors %}

                                    <p class="messages-error">{{ error }}</p>

                                {% endfor %}

                            {% endif %}
                        </div>
                    {% endfor %}

                </div>

                <button type="submit">Cadastrar</button>
            </form>
        </div>
    </div>



{% block script %}

<script>
    // --- Modal de cadastro ---
    const modalCadastro = document.getElementById("modalCadastro");
    const btnCadastro = document.querySelector(".novo-registro");
    const spanCadastro = document.querySelector("#modalCadastro .close");

    btnCadastro.addEventListener("click", function(event) {
        event.preventDefault();
        modalCadastro.style.display = "block";
    });

    spanCadastro.addEventListener("click", function() {
        modalCadastro.style.display = "none";
    });

    window.addEventListener("click", function(event) {
        if (event.target === modalCadastro) {
            modalCadastro.style.display = "none";
        }
    });

    // --- Fun√ß√µes gen√©ricas para modais de edi√ß√£o ---
    function abrirModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = "block";
        }
    }

    function fecharModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = "none";
        }
    }

    // --- Fecha qualquer modal ao clicar no X ---
    document.querySelectorAll(".modal .close").forEach(function(span) {
        span.addEventListener("click", function() {
            const modal = span.closest(".modal");
            if (modal) {
                modal.style.display = "none";
            }
        });
    });

    // --- Fecha modal ao clicar fora ---
    window.addEventListener("click", function(event) {
        if (event.target.classList.contains("modal")) {
            event.target.style.display = "none";
        }
    });
</script>


    
{% endblock  %}
    
{% endblock %}